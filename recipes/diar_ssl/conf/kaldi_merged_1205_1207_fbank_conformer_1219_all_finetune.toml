[meta]
save_dir = "exp"
seed = 3407
# save_dir 下会创建 kaldi_merged_1205_1207_fbank_conformer_1219_all_finetune 目录用于保存新的 checkpoints

[finetune]
finetune = true
ckpt_dir = "/root/code/github_repos/DiariZen/recipes/diar_ssl/exp/kaldi_merged_1205_1207_fbank_conformer_1219_all/checkpoints/epoch_0016"
# finetune = true 表示从已有 checkpoint 继续训练
# ckpt_dir 指向具体的 checkpoint 目录（包含 pytorch_model.bin）

[trainer]
path = "trainer_single_opt.Trainer"
[trainer.args]
max_epochs = 100
gradient_percentile = 90
gradient_history_size = 1000
save_max_score = false
save_ckpt_interval = 1
max_patience = 10
max_num_checkpoints = 100
gradient_accumulation_steps = 1
validation_interval = 1
freeze_wavlm = false
lr_decay = false
use_one_cycle_lr = false

[optimizer]
path = "torch.optim.AdamW"
[optimizer.args]
lr = 1e-5
# 使用较小的学习率进行 finetune

[model]
path = "diarizen.models.eend.model_fbank_conformer.Model"
[model.args]
n_fft = 400
n_mels = 128
win_length = 25
hop_length = 10
sample_rate = 16000
attention_in = 512
ffn_hidden = 1024
num_head = 4
num_layer = 8
dropout = 0.1
chunk_size = 8
use_posi = false
output_activate_function = false
selected_channel = 0
max_speakers_per_chunk = 4
max_speakers_per_frame = 2
use_powerset = true

[train_dataset]
path = "dataset.DiarizationDataset"
[train_dataset.args]
scp_file = "data/kaldi_merged_1205_1207_fbank_conformer_1219_all/train/wav.scp"
rttm_file = "data/kaldi_merged_1205_1207_fbank_conformer_1219_all/train/rttm"
uem_file = "data/kaldi_merged_1205_1207_fbank_conformer_1219_all/train/all.uem"
chunk_size = 8
chunk_shift = 6
sample_rate = 16000
full_utterance = true
max_sessions = 0
max_chunks = 0

[train_dataset.dataloader]
batch_size = 64
num_workers = 16
prefetch_factor = 4
persistent_workers = true
drop_last = true
pin_memory = true

[validate_dataset]
path = "dataset.DiarizationDataset"
[validate_dataset.args]
scp_file = "data/kaldi_merged_1205_1207_fbank_conformer_1219_all/dev/wav.scp"
rttm_file = "data/kaldi_merged_1205_1207_fbank_conformer_1219_all/dev/rttm"
uem_file = "data/kaldi_merged_1205_1207_fbank_conformer_1219_all/dev/all.uem"
chunk_size = 8
chunk_shift = 8
sample_rate = 16000
full_utterance = true
max_sessions = 0
max_chunks = 0

[validate_dataset.dataloader]
batch_size = 64
num_workers = 16
prefetch_factor = 4
persistent_workers = true
drop_last = true
pin_memory = true
